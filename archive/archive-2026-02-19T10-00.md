# Tendly Project Archive — 2026-02-19T10:00

## Project Overview
Tendly — a property management iOS app for small landlords and tenants. Built with Expo Router, NativeWind, Zustand, Supabase, Stripe, and Claude AI.

**Tech Stack:** Expo SDK 54, Expo Router v6, React Native 0.81.5, NativeWind v4.2.1, Zustand 5.0.11, Supabase JS v2.97.0, Stripe React Native v0.58.0, Claude claude-sonnet-4-6 via Supabase Edge Functions, EAS CLI.

## Current State
All screens and core features are fully implemented. A centralized theme system (`lib/theme.ts`) has been added since the last archive, and all UI components/screens now import from it. The `App.tsx` root file has been removed in favor of Expo Router's file-based routing. App is ready for deployment steps: Supabase migration, edge function deploy, Stripe webhook, and EAS build.

## Credentials
- Supabase URL/keys: `SupabaseInfo.txt` + `.env.local`
- Stripe keys: `StripeInfo.txt` + `.env.local`
- Anthropic key: `.env.local`
- Missing: `STRIPE_WEBHOOK_SECRET` (add after creating Stripe webhook endpoint)

## Code Map

### `app/`
| File | Purpose |
|------|---------|
| `_layout.tsx` | Root layout — Supabase auth listener, role+activeView-aware redirect (tenant→pay, landlord→dashboard, admin respects activeView); registers /profile modal |
| `profile.tsx` | Profile modal — avatar initials, name edit, password change (re-auth + updateUser), admin view-switch toggles, sign-out |
| `index.tsx` | Redirect to `/(auth)/login` |
| `(auth)/_layout.tsx` | Stack with no header |
| `(auth)/login.tsx` | Email/password login form; imports `colors`, `text` from `lib/theme.ts` |
| `(auth)/signup.tsx` | Landlord signup (sends role+name metadata to Supabase); imports theme tokens |
| `(landlord)/_layout.tsx` | 6-tab bar (Home, Properties, Maintenance, Messages, Tend AI, Profile) + web sidebar via SidebarLayout with LANDLORD_NAV_ITEMS |
| `(landlord)/profile-redirect.tsx` | Stub — redirects to /profile; safety net for direct navigation; tab tap is intercepted by tabBarButton |
| `(landlord)/dashboard.tsx` | Portfolio stats (units, monthly rent, open requests, emergencies) + property summary; uses theme tokens |
| `(landlord)/tenants/index.tsx` | Tenants tab — list with lease-end color coding, initials avatar, payment badge; pending invitations section; invite modal with unit picker |
| `(landlord)/tenants/[tenantId].tsx` | Tenant detail — 7 cards: contact, lease, vehicles/pets, recent payment, open maintenance, documents, actions (message + end lease) |
| `(landlord)/properties/index.tsx` | Property list with PropertyCard; + button navigates to add |
| `(landlord)/properties/add.tsx` | Add property form — split address (street/city/state/zip) with Nominatim validation, nickname, mortgage, unit count, rent; router.replace on success |
| `(landlord)/properties/[id]/index.tsx` | Property detail — address card, monthly financials (rent/mortgage/NOI), units list, delete button with safety checks |
| `(landlord)/maintenance/index.tsx` | Maintenance list with urgency+status badges |
| `(landlord)/maintenance/[id].tsx` | Maintenance detail + status change buttons (assign/resolve) |
| `(landlord)/messages/index.tsx` | Thread list (one per active lease) |
| `(landlord)/messages/[threadId].tsx` | Realtime chat thread with AI-drafted indicator (Sparkles icon) |
| `(landlord)/tend.tsx` | Tend AI chat — streams from `tend` edge function with portfolio context |
| `(landlord)/financials/index.tsx` | Per-property NOI breakdown (rent − mortgage − insurance − tax) |
| `(tenant)/_layout.tsx` | 4-tab bar (Pay Rent, Requests, Messages, Profile) + web sidebar via SidebarLayout with TENANT_NAV_ITEMS at ≥768px |
| `(tenant)/profile-redirect.tsx` | Stub — redirects to /profile |
| `(tenant)/pay.tsx` | Payment history + pending payment card |
| `(tenant)/maintenance.tsx` | Submit request with photo picker + AI triage; photos upload to `maintenance-photos` bucket |
| `(tenant)/messages.tsx` | Tenant-side chat thread; calls markAsRead on mount and new messages |
| `(tenant)/documents.tsx` | Documents tab — grouped by type, signed URL viewer via get-signed-url edge fn, acknowledge button, renters insurance upload |
| `(tenant)/onboarding.tsx` | Deep-link landing screen — reads token param, calls complete-invitation, shows lease summary, routes to pay |

### `store/`
| File | Exports |
|------|---------|
| `auth.ts` | `useAuthStore` — user, session, loading, activeView ('landlord'|'tenant'), fetchUser, setSession, setUser, setActiveView, signOut (resets activeView) |
| `properties.ts` | `usePropertiesStore` — properties[], fetchProperties, addProperty, addUnit, checkDeleteProperty, deleteProperty, error |
| `maintenance.ts` | `useMaintenanceStore` — requests[], fetchRequests, updateRequest |
| `messages.ts` | `useMessagesStore` — threads[], messages{}, unreadCounts{}, fetchThreads, fetchMessages, sendMessage, markAsRead, subscribeToMessages (INSERT + UPDATE) |
| `tenants.ts` | `useTenantsStore` — tenants[], invitations[], fetchTenants, fetchInvitations, terminateLease |

### `lib/`
| File | Exports |
|------|---------|
| `theme.ts` | `colors`, `text`, `radius`, `shadow`, `spacing`, `cardBase` — centralized design tokens; `text` includes both numeric scale (xs/sm/base/lg/xl/2xl/3xl/4xl) AND semantic role aliases (caption/secondary/body/subheading/heading/pageTitle/heroTitle/statNum/display) |
| `supabase.ts` | `supabase` client with ExpoSecureStoreAdapter |
| `utils.ts` | `formatCents`, `dollarsToCents`, `formatDate`, `calcCapRate` |
| `claude.ts` | `callTriage`, `callDraftMessage` — invoke Supabase edge functions |
| `__tests__/utils.test.ts` | 3 passing unit tests for utils |

### `components/`
| File | Exports |
|------|---------|
| `ui/Button.tsx` | `Button` (primary/secondary, loading state) — uses theme tokens |
| `ui/Input.tsx` | `Input` (label, error, all TextInput props) — uses theme tokens |
| `ui/PaywallGate.tsx` | `PaywallGate` (wraps content, shows upgrade CTA when locked) |
| `ui/KeyboardView.tsx` | `KeyboardView` — web renders plain View, native renders KeyboardAvoidingView with ios/height behavior |
| `ui/SidebarLayout.tsx` | `SidebarLayout({ navItems })` — generic 220px sidebar; accepts navItems prop; profile footer with initials avatar, name/email, admin view badge, sign-out button |
| `domain/PropertyCard.tsx` | `PropertyCard` (tap-to-navigate card) — uses theme tokens |
| `domain/MaintenanceBadge.tsx` | `UrgencyBadge`, `StatusBadge` — uses theme tokens |

### `lib/`
| File | Exports |
|------|---------|
| `alert.ts` | `showAlert(title, message?)`, `showConfirm(title, message, onConfirm, confirmLabel?)` — window.alert/window.confirm on web, Alert.alert on native |

### `supabase/`
| Path | Purpose |
|------|---------|
| `migrations/001_initial_schema.sql` | All 10 tables + RLS policies + 2 triggers |
| `functions/triage/index.ts` | Claude → JSON `{urgency, trade}` |
| `functions/tend/index.ts` | Claude streaming chat with portfolio context |
| `functions/draft-message/index.ts` | Claude → professional landlord message draft |
| `functions/stripe-webhook/index.ts` | Stripe subscription sync → subscriptions table |

### `hooks/`
| File | Exports |
|------|---------|
| `useSubscription.ts` | `useSubscription` — subscription, isPaid, unitCount, atFreeLimit |

### `types/`
| File | Exports |
|------|---------|
| `index.ts` | User (+ is_admin: boolean), Property, Unit, Lease, RentPayment, MaintenanceRequest, Vendor, Message, Document, Subscription + all enum types |

## Remaining Manual Steps
1. **Supabase migration** — paste `supabase/migrations/001_initial_schema.sql` into Supabase SQL Editor and run
2. **Storage bucket** — Supabase → Storage → New bucket: name=`documents`, public=No
3. **Edge Function secrets** — Supabase dashboard → Edge Functions → Secrets: set `ANTHROPIC_API_KEY`, `STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET`, `SUPABASE_SERVICE_ROLE_KEY`
4. **Deploy edge functions** — `npx supabase functions deploy triage tend draft-message stripe-webhook`
5. **Stripe webhook** — Add endpoint `https://zrfyvrwordbjgvpicdvq.supabase.co/functions/v1/stripe-webhook` in Stripe dashboard, then copy secret to `.env.local`
6. **EAS setup** — `eas init && eas build --profile development --platform ios`

## Change Log
| Timestamp | Files | Summary |
|-----------|-------|---------|
| 2026-02-18T21:00 | package.json, app.json, babel.config.js, tailwind.config.js, global.css, assets/ | Scaffolded Expo project, installed all deps, configured NativeWind + Jest |
| 2026-02-18T21:10 | types/index.ts | All domain types and enums |
| 2026-02-18T21:15 | supabase/migrations/001_initial_schema.sql, .env.local | DB schema with RLS + triggers; env file with all credentials |
| 2026-02-18T21:25 | lib/supabase.ts, lib/utils.ts, lib/__tests__/utils.test.ts | Supabase client, utility functions, 3 passing tests |
| 2026-02-18T21:35 | store/auth.ts, app/_layout.tsx, app/index.tsx, app/(auth)/*, components/ui/* | Auth store, root layout, login/signup screens, Button, Input |
| 2026-02-18T21:40 | app/(landlord)/* (stubs) | Tab layout with 5-tab bar, stub screens |
| 2026-02-18T21:50 | store/properties.ts, store/maintenance.ts, store/messages.ts, components/domain/*, app/(landlord)/properties/*, app/(landlord)/maintenance/*, app/(landlord)/messages/* | Properties/maintenance/messages stores and full screens |
| 2026-02-18T22:00 | supabase/functions/*, lib/claude.ts, app/(landlord)/tend.tsx, hooks/useSubscription.ts, components/ui/PaywallGate.tsx, app/(landlord)/dashboard.tsx, app/(tenant)/*, app/(landlord)/financials/* | All AI edge functions, Tend chat, subscription gate, full dashboard, full tenant app, financials screen |
| 2026-02-19T10:00 | lib/theme.ts (NEW), all UI components, all landlord+auth screens, store/properties.ts, babel.config.js, package.json | Added centralized theme token system; all components and screens migrated to use theme tokens; App.tsx removed (Expo Router handles root); error field added to properties store |
| 2026-02-19T11:00 | index.ts, lib/supabase.ts, lib/alert.ts (NEW), components/ui/KeyboardView.tsx (NEW), components/ui/SidebarLayout.tsx (NEW), app/(landlord)/_layout.tsx, app/(auth)/login.tsx, app/(auth)/signup.tsx, app/(landlord)/tend.tsx, app/(landlord)/messages/[threadId].tsx, app/(landlord)/maintenance/[id].tsx, app/(landlord)/properties/add.tsx, app/(tenant)/maintenance.tsx, app/(tenant)/messages.tsx, app.json, .github/workflows/deploy.yml (NEW), package.json | Added full web platform support: platform-aware Supabase storage (localStorage on web), cross-platform Alert shim, KeyboardAvoidingView shim, web image picker in tenant maintenance, responsive sidebar nav (≥768px) vs bottom tabs (<768px), static export config, GitHub Pages deploy workflow |
| 2026-02-19T11:30 | lib/supabase.ts | Fixed localStorage SSR crash: added `typeof localStorage !== 'undefined'` guards so Node.js pre-render pass returns null instead of throwing |
| 2026-02-19T12:00 | app/(auth)/login.tsx, app/(auth)/signup.tsx | Responsive auth screens: useWindowDimensions → gray-50 background + centered 440px card on desktop (≥768px), unchanged on mobile |
| 2026-02-19T12:30 | app/(landlord)/properties/[id]/index.tsx (NEW), app/_layout.tsx, lib/theme.ts, app/(landlord)/tend.tsx, app/(landlord)/messages/[threadId].tsx | Created missing property detail screen (address, financials, units list); fixed auth redirect guard with initialized state; fixed shadow* deprecation with Platform.select boxShadow on web; removed disabled prop from TouchableOpacity send buttons to fix pointerEvents warning |
| 2026-02-19T13:00 | lib/alert.ts, store/properties.ts, app/(landlord)/properties/[id]/index.tsx | Added showConfirm utility; added checkDeleteProperty (active lease + open maintenance checks) and deleteProperty to properties store; added delete button to property detail screen with two-step safety check → confirm dialog → delete flow |
| 2026-02-19T13:30 | components/ui/Button.tsx, app/(landlord)/properties/add.tsx | Fixed Button pointerEvents warning (onPress=undefined instead of disabled prop); fixed GO_BACK crash (router.replace instead of router.back); split address into street/city/state/zip fields; added Nominatim geocoding validation before save |
| 2026-02-19T15:00 | app/(landlord)/dashboard.tsx, app/(landlord)/properties/index.tsx, app/(landlord)/maintenance/index.tsx, app/(landlord)/messages/index.tsx, app/(landlord)/financials/index.tsx, app/(tenant)/pay.tsx, app/(tenant)/maintenance.tsx, app/(tenant)/messages.tsx | Responsive grid layout on all list screens: useWindowDimensions → 2-column card grid at ≥768px (FlatList numColumns=2 + columnWrapperStyle, ScrollView flexWrap grid); consistent hPad=24/gap=16 on wide vs hPad=20 on mobile; tenant screens converted from NativeWind className to StyleSheet; tenant messages chat capped at maxWidth 800; tenant maintenance form centered at maxWidth 600 on wide |
| 2026-02-19T14:00 | supabase/migrations/002_add_is_admin.sql (NEW), types/index.ts, store/auth.ts, app/_layout.tsx, app/profile.tsx (NEW), components/ui/SidebarLayout.tsx, app/(landlord)/_layout.tsx, app/(tenant)/_layout.tsx, app/(landlord)/profile-redirect.tsx (NEW), app/(tenant)/profile-redirect.tsx (NEW) | Tenant routing fix (role-aware redirect in root layout); admin is_admin flag + activeView state in auth store; profile modal screen (name edit, password change, admin view-switch, sign-out); SidebarLayout refactored to accept navItems prop + profile footer with avatar/sign-out; Profile tab added to landlord + tenant layouts (mobile tab bar + web sidebar); tenant layout gains responsive sidebar at ≥768px |
| 2026-02-19T16:00 | lib/theme.ts, components/domain/PropertyCard.tsx, app/(landlord)/dashboard.tsx, app/(landlord)/maintenance/index.tsx, app/(landlord)/messages/index.tsx, app/(landlord)/financials/index.tsx, app/(landlord)/maintenance/[id].tsx, app/(landlord)/properties/[id]/index.tsx, app/(tenant)/pay.tsx, app/profile.tsx, app/(auth)/login.tsx, app/(auth)/signup.tsx | Added spacing and cardBase exports to theme.ts; replaced all hardcoded card style properties (backgroundColor, borderRadius, borderWidth, borderColor, padding) across every screen and component with ...cardBase spread + spacing.cardPad/cardGap/cardInnerGap constants; PropertyCard marginBottom removed (gap handled by FlatList contentContainerStyle) |
| 2026-02-19T16:30 | app/profile.tsx | Fixed profile header alignment bug: innerW formula was Math.min(width, maxContentW) - hPad*2 (wrong) → Math.min(width - hPad*2, maxContentW) (correct); header now exactly equals colW*2+gap at all viewport sizes; inner View uses explicit width: innerW on wide to eliminate flex/percentage browser ambiguity |
| 2026-02-19T16:45 | app/profile.tsx, app/(landlord)/maintenance/index.tsx, app/(landlord)/messages/index.tsx | Equal card heights in 2-column grid: profile row alignItems changed from flex-start → stretch; FlatList columnWrapperStyle gains alignItems: stretch on maintenance and messages screens; cards stretch to match tallest sibling in each row |
| 2026-02-19T17:00 | lib/theme.ts, all 21 tsx files in app/ and components/ | Added semantic font size aliases to text export (caption/secondary/body/subheading/heading/pageTitle/heroTitle/statNum/display); bulk-replaced all fontSize: text.xs/sm/base/lg/xl/'2xl'/'3xl' usages with semantic names; added 4xl:36 to numeric scale; fixed hardcoded fontSize:36 in pay.tsx → text.display; auth screen titles use heroTitle (30) not statNum |
| 2026-02-19T17:30 | lib/theme.ts, app/(landlord)/tend.tsx, app/(landlord)/dashboard.tsx, app/(landlord)/properties/index.tsx, app/(landlord)/maintenance/index.tsx, app/(landlord)/messages/index.tsx, app/(landlord)/financials/index.tsx, app/(tenant)/pay.tsx, app/(tenant)/maintenance.tsx, app/(tenant)/messages.tsx | Standardized page headers: added headerBase export to theme.ts (white bg, bottom border, paddingTop:20/paddingBottom:16); updated all 9 screens to use ...headerBase; tend/tenant-messages headerTitle bumped from text.heading→text.pageTitle; dashboard/financials/pay/tenant-maintenance titles extracted from ScrollView into a fixed header View above the scroll |
| 2026-02-19T18:00 | app/(landlord)/properties/add.tsx | Removed Nominatim geocoding validation from add property form — was rejecting valid addresses due to non-compliant User-Agent and OpenStreetMap coverage gaps; field-filled check retained as sole validation |
| 2026-02-19T18:15 | lib/alert.ts, app/(landlord)/properties/add.tsx, app/profile.tsx | Fixed spinners never stopping: (1) deferred window.alert() via setTimeout(0) on web so React can flush setSaving(false) state before the browser is blocked; (2) wrapped handleSave/handleSaveName/handleChangePassword in try/finally to guarantee spinner resets even on thrown exceptions |
| 2026-02-19T18:30 | app/(landlord)/dashboard.tsx, app/(landlord)/financials/index.tsx | Made all card-like elements interactive: dashboard stat cards now navigate (units→properties, rent→financials, requests/emergencies→maintenance); dashboard property cards navigate to property detail; financials per-property cards navigate to property detail |
| 2026-02-19T19:30 | supabase/migrations/002–005_*.sql (NEW), supabase/functions/invite-tenant,complete-invitation,get-signed-url,acknowledge-document (NEW), store/tenants.ts (NEW), store/messages.ts, types/index.ts, app/(landlord)/tenants/index.tsx (NEW), app/(landlord)/tenants/[tenantId].tsx (NEW), app/(tenant)/documents.tsx (NEW), app/(tenant)/onboarding.tsx (NEW), app/(landlord)/_layout.tsx, app/(tenant)/_layout.tsx, app/_layout.tsx, app/profile.tsx, app/(tenant)/maintenance.tsx, app/(landlord)/messages/index.tsx, app/(landlord)/messages/[threadId].tsx, app/(tenant)/messages.tsx, lib/claude.ts | Full tenant management system: Tenants tab (landlord) with invite modal + pending invitations; tenant detail (contact, lease, vehicles/pets, payments, maintenance, actions); Documents tab (tenant) with signed URL viewer, acknowledge, insurance upload; onboarding deep-link screen; 4 edge functions; 4 DB migrations; tenant profile section in profile modal (phone, emergency contact, vehicles, pets); messaging read receipts with unread badge; maintenance photos → maintenance-photos public bucket; deep link + lease check in root layout |
